version: v1.0
name: Cross-platform pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: iisue/alpine-android-fastlane

blocks:
  - name: "Build for Android"
    dependencies: []
    task:
      jobs:
      - name: "Build"
        commands:
          - cd Android/GitViewer
          - gem update --system
          - gem install bundler --force
          - bundle install --path vendor/bundle
      - prologue:
          commands:
            - checkout

  - name: "Build for iOS"
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      jobs:
      - name: "Build"
        commands:
          - cd iOS/GitViewer
          - bundle install --path vendor/bundle
      - prologue:
          commands:
            - checkout

  - name: "Test on iOS"
    dependencies: ["Build for iOS"]
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      jobs:
      - name: "Tests"
        commands:
          - bundle exec fastlane lint

  - name: "Test on Android"
    dependencies: ["Build for Android"]
    task:
      jobs:
      - name: "Tests 1/2"
        commands:
          - echo "Test completed"
      - name: "Tests 2/2"
        commands:
          - echo "Test completed"

  - name: "Release"
    dependencies: ["Test on Android", "Build for iOS"]
    task:
      jobs:
      - name: "ðŸš€ Google Play"
        commands:
          - echo "Release completed"
      - name: "ðŸš€ AppStore"
        commands:
          - echo "Release completed"
