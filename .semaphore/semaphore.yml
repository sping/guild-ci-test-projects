version: v1.0
name: Cross-platform pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: iisue/alpine-android-fastlane

blocks:
  - name: "Test on iOS"
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      prologue:
        commands:
          - checkout
          - cd iOS/GitViewer
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: "Tests"
          commands:
            - bundle exec fastlane lint

  - name: "Build for iOS"
    dependencies: ["Test on iOS"]
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      prologue:
        commands:
          - checkout
          - cd iOS/GitViewer
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: "Build"
          commands:
            - echo 'fastlane deploy_xxx'
