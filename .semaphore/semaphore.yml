version: v1.0
name: Cross-platform pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: iisue/alpine-android-fastlane

blocks:
  - name: "Test on iOS"
    dependencies: []
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      env_vars:
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - checkout
          - cd iOS/GitViewer
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: "Tests"
          commands:
            - cache restore pods-ios-$SEMAPHORE_GIT_BRANCH-$(checksum Podfile.lock)
            - cache restore cocao-pods-ios-$SEMAPHORE_GIT_BRANCH-$(checksum Podfile.lock)
            - bundle exec fastlane lint
            - cache store pods-ios-$SEMAPHORE_GIT_BRANCH-$(checksum Podfile.lock) Pods
            - cache store cocao-pods-ios-$SEMAPHORE_GIT_BRANCH-$(checksum Podfile.lock) ~/.cocoapods

  - name: "Build for iOS"
    dependencies: ["Test on iOS"]
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-mojave
      env_vars:
        - name: LANG
          value: en_US.UTF-8
      prologue:
        commands:
          - checkout
          - cd iOS/GitViewer
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: "Build"
          commands:
            - echo 'fastlane deploy_xxx'

  - name: "Test on Android"
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
          - cd Android/GitViewer
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: "Tests"
          commands:
            - gradlew lint

