version: 2.1

jobs:
  checkout_code:
    docker:
      - image: circleci/ruby:2.6.3-node
    working_directory: ~/guild-ci-test-projects
    steps:
      - checkout
      - save_cache:
          key: '{{ .Environment.CACHE_VERSION }}-repo-{{ .Environment.CIRCLE_SHA1 }}'
          paths:
            - ~/guild-ci-test-projects

  bundle_dependencies:
    parameters:
      platform:
        description: "iOS or Android"
        type: enum
        enum: ["iOS", "Android"]
    docker:
      - image: circleci/ruby:2.6.3-node
    working_directory: ~/guild-ci-test-projects/<< parameters.platform >>/GitViewer/
    steps:
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-repo-{{ .Environment.CIRCLE_SHA1 }}'
      - restore_cache:
          keys:
            - '{{ .Environment.CACHE_VERSION }}-bundle-<< parameters.platform >>-{{ checksum "Gemfile.lock" }}'
            - '{{ .Environment.CACHE_VERSION }}-bundle-<< parameters.platform >>'
      - run: gem update --system
      - run: gem install bundle
      - run: bundle install --path vendor/bundle
      - save_cache:
          key: '{{ .Environment.CACHE_VERSION }}-bundle-<< parameters.platform >>-{{ checksum "Gemfile.lock" }}'
          paths:
            - vendor/bundle

  bundle_pods:
    docker:
      - image: circleci/ruby:2.6.3-node
    working_directory: ~/guild-ci-test-projects/iOS/GitViewer/
    steps:
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-repo-{{ .Environment.CIRCLE_SHA1 }}'
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-bundle-iOS-{{ checksum "Gemfile.lock" }}'
      - restore_cache:
          keys:
            - '{{ .Environment.CACHE_VERSION }}-pods-iOS-{{ checksum "Podfile.lock" }}'
            - '{{ .Environment.CACHE_VERSION }}-pods-iOS'
      - run: gem update --system
      - run: gem install bundle
      - run: bundle install --path vendor/bundle
      - run: bundle exec pod install
      - save_cache:
          key: '{{ .Environment.CACHE_VERSION }}-pods-iOS-{{ checksum "Podfile.lock" }}'
          paths:
            - Pods
            - ~/.cocoapods

  fastlane_ios:
    parameters:
      command:
        description: "Fastlane command to run"
        type: string
    docker:
      - image: circleci/ruby:2.6.3-node
    working_directory: ~/guild-ci-test-projects/iOS/GitViewer/
    steps:
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-repo-{{ .Environment.CIRCLE_SHA1 }}'
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-bundle-iOS-{{ checksum "Gemfile.lock" }}'
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-pods-iOS-{{ checksum "Podfile.lock" }}'
      - run: gem update --system
      - run: gem install bundle
      - run: bundle install --path vendor/bundle
      - run:
          command: bundle exec fastlane << parameters.command >>

  fastlane_android:
    parameters:
      command:
        description: "Fastlane command to run"
        type: string
    docker:
      - image: circleci/ruby:2.6.3-node
    working_directory: ~/guild-ci-test-projects/Android/GitViewer/
    steps:
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-repo-{{ .Environment.CIRCLE_SHA1 }}'
      - restore_cache:
          key: '{{ .Environment.CACHE_VERSION }}-bundle-Android-{{ checksum "Gemfile.lock" }}'
      - run: gem update --system
      - run: gem install bundle
      - run: bundle install --path vendor/bundle
      - run:
          command: bundle exec fastlane << parameters.command >>

workflows:
  build:
    jobs:
      - checkout_code:
          context: guild-ci-test-projects-fastlane
      # iOS
      - bundle_dependencies:
          name: bundle_ios_dependencies
          platform: iOS
          context: guild-ci-test-projects-fastlane
          requires:
            - checkout_code
      - bundle_pods:
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_ios_dependencies
      - fastlane_ios:
          name: lint-ios
          command: lint
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_pods
      - fastlane_ios:
          name: build-and-deploy-ios-staging
          command: deploy_staging
          context: guild-ci-test-projects-fastlane
          requires:
            - lint-ios
          filters:
            branches:
              only: /Fabric/Staging/.*$/
      - fastlane_ios:
          name: build-and-deploy-ios-production
          command: deploy_production
          context: guild-ci-test-projects-fastlane
          requires:
            - lint-ios
          filters:
            branches:
              only: /Fabric/Production/.*$/
      - fastlane_ios:
          name: build-and-deploy-ios-release
          command: deploy_app_store
          context: guild-ci-test-projects-fastlane
          requires:
            - lint-ios
          filters:
            branches:
              only: /Appstore/.*$/
      # Android
      - bundle_dependencies:
          name: bundle_android_dependencies
          platform: Android
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_android_dependencies
      - fastlane_android:
          name: build-and-deploy-android-staging
          command: deploy_staging
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_android_dependencies
          filters:
            branches:
              only: /Fabric/Staging/.*$/
      - fastlane_android:
          name: build-and-deploy-android-production
          command: deploy_production
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_android_dependencies
          filters:
            branches:
              only: /Fabric/Production/.*$/
      - fastlane_android:
          name: build-and-deploy-android-release
          command: deploy_play_store
          context: guild-ci-test-projects-fastlane
          requires:
            - bundle_android_dependencies
          filters:
            branches:
              only: /GooglePlayStore/.*$/
